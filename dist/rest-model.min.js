!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.RestModel=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d=a("./lib/cache"),e=a("./lib/utils"),f=b.exports=Ember.Object.extend({assignErrors:function(a){},attrs:function(){return[]}.property(),arraysAreEqual:function(a,b){var c,d,e,f=a.length>=b.length?a:b,g=a.length>=b.length?b:a;for(c=0;c<f.length+1;c++)if(d=f[c],e=g[c],Ember.isArray(d)&&Ember.isArray(e)){if(!this.arraysAreEqual(d,e))return!1}else if(!Ember.isEqual(d,e))return!1;return!0},init:function(){var a=this;this.setOriginalProperties();var b=Ember.computed.apply(Ember,this.get("observableAttrs").concat(function(b,c){var d,e=a.get("attrs"),f=a.get("originalProperties");for(d=0;d<e.length;d++){b=e[d],c=a.get(b);var g=f.get(b);if(Ember.isArray(c)&&Ember.isArray(g)){if(!this.arraysAreEqual(c,g))return!0}else if(!Ember.isEqual(c,g))return!0}return!1}));Ember.defineProperty(this,"isDirty",b)},"delete":function(a){return this.submit("delete",a)},errors:function(){return[]}.property(),fetch:function(a,b){var c=this.get("parentKeys"),d=this.getPrimaryKey();return this.constructor.find(c,d,b).then(function(a){return this.setProperties(a),this}.bind(this))},getParentKeys:function(){return this.parents?this.parents.map(function(a){return"number"==typeof a||"string"==typeof a?a:a.getPrimaryKey()}):[]},getPrimaryKey:function(){for(var a,b,c=this.constructor.primaryKeys,d=0;d<c.length;d++)if(a=c[d],b=this.get(a),"undefined"!=typeof b&&null!==b)return b},isPersisted:function(){var a=this.get("created_at");return"undefined"!=typeof a&&null!==a}.property("created_at"),observableAttrs:function(){return this.get("attrs").map(function(a){var b=this.get(a);return Ember.isArray(b)?a+".[]":a}.bind(this))}.property("attrs.[]"),pick:function(a){var b=this;return a.reduce(function(a,c){return a[c]=b.get(c),a},{})},revert:function(){var a=this.get("originalProperties");return this.setProperties(Object.keys(a).reduce(function(b,c){return b[c]=Ember.copy(a[c],!0),b}.bind(this),{}))},save:function(a){var b,c=this;return b=this.get("isPersisted")?"patch":"post",this.constructor.saveViaPut&&(b="put"),this.submit(b,a).then(function(){return c.setOriginalProperties()})},setOriginalProperties:function(){var a=this,b=this.get("attrs");this.set("originalProperties",Ember.keys(this).reduce(function(c,d){return-1===b.indexOf(d)?c:c.set(d,Ember.copy(a[d],!0))},Ember.Object.create()))},serialize:function(){if(void 0!==this.get("serializedProperties")&&null!==this.get("serializedProperties")){var a=this.pick(this.get("serializedProperties"));return JSON.stringify(a)}return JSON.stringify(this)},submit:function(a,b){var c=this.getParentKeys(),d=this;return"delete"===a?this.set("isDeleting",!0):this.set("isSaving",!0),new Ember.RSVP.Promise(function(e,f){d.constructor[a](c,d,b).then(function(a){d.get("errors").setObjects([]),d.setProperties(a),e(d)},function(a){d.assignErrors(a),f(a)})["finally"](function(){"delete"===a?d.set("isDeleting",!1):d.set("isSaving",!1)})})}}).reopenClass({ajax:function(a){var b,c=this,e=a.method||"GET",f=this.getCacheKey(a);return a.hasOwnProperty("cache")||(a.cache=this.cache),new Ember.RSVP.Promise(function(g,h){var i;a.cache&&(b=d.getModels(c,f))&&(i=c.processResponse(b,a),g(i)),$.ajax({url:a.url,type:e,data:a.data,headers:a.headers||{},beforeSend:c.getBeforeSend(a),dataType:"json",contentType:"application/json"}).then(function(b,h,j){var k=c.processResponse(b,a);a.cache&&"GET"===e&&b&&d.update(c,f,b),i?c.updateCachedResponse(i,k):g(a.rawResponse?b:k)},function(a){delete a.then,h(a)})})},all:function(a,b){var c=this.extractPrimaryKeys(a),d=this.buildURL(c,null,b);return b=$.extend({url:d,parents:a},b),this.ajax(b)},buildURL:function(a,b,c){var d;c=c||{},d=c.withURL?c.withURL:this.url;var e=Ember.String.fmt(d.replace(/\/:[^\/]+/g,"/%@"),a),g=this.namespace||f.namespace;return g=g?"/"+g:"",Ember.isBlank(b)||(e=[e,b].join("/")),g+e},"delete":function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,b.getPrimaryKey(),c);return this.ajax({url:e,method:"DELETE",rawResponse:!0})},deserializeArray:function(a){var b=this;return $.map(a,function(a){return b.deserialize(a)})},deserialize:function(a){return this.create(a)},extractPrimaryKeys:function(a){return Ember.makeArray(a).map(function(a){return"number"==typeof a||"string"==typeof a?a:a.getPrimaryKey()})},find:function(a,b,c){("number"==typeof a||"string"==typeof a)&&(b=a,a=void 0);var d=this.extractPrimaryKeys(a),e=this.buildURL(d,b,c);return this.ajax({url:e,parents:a})},getBeforeSend:function(a){return function(a){}},getCacheKey:function(a){var b=a.method||"GET";return"%@: %@ - %@".fmt(this.toString(0),b,a.url)},namespace:null,objectToArray:function(a){var b=[];return Object.keys(a).forEach(function(c){b.push({key:c,value:a[c]})}),b},patch:function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,b.getPrimaryKey(),c),f=b.serialize("patch");return c=c||{},this.ajax({url:e,method:"PATCH",data:f,rawResponse:!0,headers:c.headers})},post:function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,null,c),f=b.serialize("post");return c=c||{},this.ajax({url:e,method:"POST",data:f,rawResponse:!0,headers:c.headers})},put:function(a,b,c){var d=this.extractPrimaryKeys(a),e=this.buildURL(d,null,c),f=b.serialize("put");return c=c||{},this.ajax({url:e,method:"PUT",data:f,rawResponse:!0,headers:c.headers})},primaryKeys:["id"],processResponse:function(a,b){return this.forceArray&&(a=this.objectToArray(a)),a=$.isArray(a)?this.deserializeArray(a):this.deserialize(a),b.parents&&Ember.makeArray(a).forEach(function(a){a.set("parents",Ember.makeArray(b.parents))}),a},saveViaPut:!1,updateCachedResponse:function(a,b){var c=this;$.isArray(a)?(a.forEach(function(d){return e.findMatching(d,c,b)?void 0:a.removeObject(d)}),b.forEach(function(b){var d=e.findMatching(b,c,a);if(d){var f=d.get("attrs"),g=f.reduce(function(a,c){return a[c]=b.get(c),a},{});return d.setProperties(g)}return a.pushObject(b)})):a.setProperties(b)}});f.V2=a("./index-v2")},{"./index-v2":2,"./lib/cache":5,"./lib/utils":7}],2:[function(a,b,c){"use strict";var d=a("./lib/mutating-array"),e=a("./lib/cache-v2").create(),f=a("./lib/utils");b.exports=Ember.Object.extend({isRestModelClass:!0,init:function(){this.setOriginalProperties(),this._definePrimaryKey(),this._defineDirtyProperties()},attrs:function(){return[]}.property(),inFlight:Ember.computed.bool("requestPool"),isClean:Ember.computed.empty("dirtyProperties"),isDirty:Ember.computed.notEmpty("dirtyProperties"),isNew:Ember.computed.none("primaryKey"),isPersisted:Ember.computed.not("isNew"),attrNames:function(){return this.get("attrs").map(function(a){return/\.\[\]$/.test(a)?a.split(".")[0]:a})}.property("attrs"),parents:function(){var a=this.constructor.getParentKeyNames();return a.reduce(function(a,b){return a[b]=this.get(b),a}.bind(this),{})}.property()["volatile"](),path:function(){var a=this.get("isPersisted")?this.get("primaryKey"):null,b=this.get("parents");return this.constructor.buildPath(b,a)}.property("primaryKey","parents"),"delete":function(a){return this.request("deleting",function(){return a=f.extend({url:this.get("path"),type:"DELETE"},a),this.constructor.ajax(a).then(function(){return e.removeRecord(this)}.bind(this))}.bind(this))},fetch:function(a){return this.request("fetching",function(){return a=f.extend({url:this.get("path"),type:"GET"},a),this.constructor.request(a,{},this).then(function(a){var b=this.constructor.getUpdatableProperties(a);return this.setProperties(b),this.setOriginalProperties(),this}.bind(this))}.bind(this))},persistToCache:function(a){return e.updateRecord(this,a)},request:function(a,b){return a="is%@".fmt(a.capitalize()),this.set(a,!0),this.incrementProperty("requestPool"),b()["finally"](function(){this.set(a,!1),this.decrementProperty("requestPool")}.bind(this))},revert:function(){var a=this.get("attrs");this.get("attrNames").forEach(function(b,c){var d=Ember.copy(this.get("originalProperties.%@".fmt(b)));/\.\[\]$/.test(a[c])?this.get(b).setObjects(d):this.set(b,d)}.bind(this))},save:function(a){var b=this.get("isNew")?"POST":"PATCH";return this.request("saving",function(){return a=f.extend({url:this.get("path"),type:b,data:this.serialize()},a),this.constructor.ajax(a).then(function(a){return this.persistToCache(a)}.bind(this)).then(function(a){return this.setProperties(a),this.setOriginalProperties(),this}.bind(this))}.bind(this))},setOriginalProperties:function(){var a=this.get("attrNames");this.set("originalProperties",a.reduce(function(a,b){var c=this.get(b);return a.set(b,Ember.copy(c,!0)),a}.bind(this),Ember.Object.create()))},getDirtyProperties:function(){var a=this.get("attrNames"),b=this.get("originalProperties");return a.reduce(function(a,c){var d=this.get(c),e=b.get(c);return Ember.isArray(d)?f.arraysEqual(d,e)||a.push(c):Ember.$.isPlainObject(d)?f.objectsEqual(d,e)||a.push(c):Ember.isEqual(d,e)||a.push(c),a}.bind(this),[])},serialize:function(){return JSON.stringify(this.toObject())},toObject:function(){return this.get("attrNames").reduce(function(a,b){var c=this.get(b);return a[b]=c,a}.bind(this),{})},_definePrimaryKey:function(){var a=this.constructor.primaryKeys.concat(function(a,b){var c=this.constructor.primaryKeys;if(void 0!==b)return this.get("primaryKey")!==b&&this.set(c[0],b),b;for(var d,e,f=0;f<c.length;f++)if(d=c[f],e=this.get(d),!Ember.isNone(e))return e}),b=Ember.computed.apply(Ember,a);Ember.defineProperty(this,"primaryKey",b)},_defineDirtyProperties:function(){var a=this.get("attrs").concat("originalProperties",this.getDirtyProperties),b=Ember.computed.apply(Ember,a);Ember.defineProperty(this,"dirtyProperties",b)}}).reopenClass({typeKey:"",primaryKeys:["id"],namespace:null,base:"",cache:!1,filters:[],ajax:function(a){var b={type:"GET",dataType:"json",contentType:"application/json"};return f.extend(b,a),new Ember.RSVP.Promise(function(a,c){Ember.$.ajax(b).then(function(b){b=Ember.isArray(b)?this.deserializeArray(b):this.deserialize(b),a(b)}.bind(this),function(a){delete a.then,c(a)})}.bind(this))},all:function(a,b){b=f.extend({url:this.buildPath(a),type:"GET"},b);var c={parents:a};return this.request(b,c).then(function(a){return a})},addParentsToPath:function(a,b){return Ember.$.each(a,function(a,c){var d=c;"string"!=typeof c&&"number"!=typeof c&&(d=c.get("primaryKey")),b=b.replace("/:%@".fmt(a),"/%@".fmt(d))}),b},assertHasParentKeys:function(a){this.getParentKeyNames().forEach(function(b){var c=a[b],d=c?this.getPrimaryKey(c):null;if(Ember.isNone(d))throw new Error('No primary key found for parent "%@".'.fmt(b))}.bind(this))},buildPath:function(a,b){var c="/"+this.base;return Ember.$.isPlainObject(a)||(b=a,a={}),this.assertHasParentKeys(a),c=this.addParentsToPath(a,c),Ember.isNone(b)||(c+="/"+b),Ember.isNone(this.namespace)||(c="/"+this.namespace+c),c},deserialize:function(a){return a},deserializeArray:function(a){return a.map(this.deserialize.bind(this))},find:function(a,b,c){return Ember.$.isPlainObject(a)||(c=b,b=a,a={}),c=f.extend({url:this.buildPath(a,b),type:"GET"},c),this.request(c).then(this.create.bind(this)).then(function(b){return b.setProperties(a),b})},getParentKeyNames:function(){var a=this.base.match(/\/:[^\/]+/g)||[];return a.map(function(a){return a.replace("/:","")})},getPrimaryKey:function(a){return"number"==typeof a||"string"==typeof a?a:a.get("primaryKey")},toResult:function(a,b){if(b=b||{},Ember.isArray(a)){var c=a.map(function(a){return this.create(a).setProperties(b)}.bind(this));return d.apply(c).set("filters",Ember.copy(this.filters)).runFilters()}return this.create(a).setProperties(b)},request:function(a,b,c){var d=this.cache&&"get"===a.type.toLowerCase();return b=f.extend({toResult:this.toResult.bind(this)},b),d?this.requestWithCache(a,b,c):this.ajax(a).then(function(a){var c=b.parents;return b.toResult(a,c)})},requestWithCache:function(a,b,c){var d;return e.getResponse(this,a.url).then(function(e){var f;return d=e,d?(f=b.toResult(d,b.parents),this.ajaxAndUpdateCache(a,b,c||f),f):this.ajaxAndUpdateCache(a,b).then(function(a){return b.toResult(a)})}.bind(this)).then(function(a){return a})},ajaxAndUpdateCache:function(a,b,c){var d=b.parents;return this.ajax(a).then(function(b){return e.setResponse(this,a.url,b)}.bind(this)).then(function(a){return a=b.toResult(a,d),c?Ember.isArray(a)?this.updateCachedArray(c,a):this.updateCachedObject(c,a):a}.bind(this))},updateCachedArray:function(a,b){var c=f.findNotIn(b,a,this),d=f.findNotIn(a,b,this),e=f.findIn(a,b,this);return a.pushObjects(c),a.removeObjects(d),e.forEach(function(a){if(!a.get("isDirty")){var c=f.findMatching(a,this,b);c=this.getUpdatableProperties(c),a.setProperties(c),a.setOriginalProperties()}}.bind(this)),a},updateCachedObject:function(a,b){return a.get("isDirty")?void 0:(b=this.getUpdatableProperties(b),a.setProperties(b),a.setOriginalProperties(),a)},getUpdatableProperties:function(a){var b=Ember.keys(a).filter(function(a){return-1===["originalProperties","dirtyProperties"].indexOf(a)});return a.getProperties(b)},create:function(a){if(a=a||{},a.isRestModelClass){var b={},c={};return Ember.keys(a).forEach(function(d){var e=a[d];e instanceof Ember.ComputedProperty?c[d]=e:b[d]=e}),this.extend(c)._super.call(this,b)}return this._super.call(this,a)}})},{"./lib/cache-v2":4,"./lib/mutating-array":6,"./lib/utils":7}],3:[function(a,b,c){function d(){var a=function(){};this.getItem=a,this.setItem=a,this.removeItem=a,this.clear=a,this.key=a,this.length=0}b.exports.NullStorage=d,b.exports.get=function(){try{return localStorage.setItem("_rest-model",!0),localStorage.removeItem("_rest-model",!0),localStorage}catch(a){return new d}}},{}],4:[function(a,b,c){"use strict";var d=a("./cache-storage");b.exports=Ember.Object.extend({getResponse:function(a,b){return this.getItem(b).then(function(b){return Ember.isArray(b)?this.getArrayResponse(a,b):this.getItemResponse(a,b)}.bind(this))},storage:d.get(),getArrayResponse:function(a,b){return Ember.RSVP.all(b.map(function(b){var c=this.getCacheKey(a.typeKey,b);return this.getItem(c)}.bind(this))).then(function(a){return a.compact()})},getItemResponse:function(a,b){var c=this.getCacheKey(a.typeKey,b);return this.getItem(c)},setResponse:function(a,b,c){return Ember.isArray(c)?this.setArrayResponse(a,b,c):this.setItemResponse(a,b,c)},setArrayResponse:function(a,b,c){var d=a.primaryKeys[0],e=c.mapBy(d);return Ember.RSVP.all([this.setItem(b,e),c.map(function(b){var c=this.getCacheKey(a.typeKey,b[d]);return this.putItem(c,b)}.bind(this))]).then(function(){return c})},setItemResponse:function(a,b,c){var d=a.primaryKeys[0],e=c[d],f=this.getCacheKey(a.typeKey,e);return Ember.RSVP.all([this.putItem(f,c),this.setItem(b,e)]).then(function(){return c})},removeRecord:function(a){var b,c,d=a.constructor.typeKey;return a.constructor.primaryKeys.length&&(c=a.get(a.constructor.primaryKeys[0])),b=this.getCacheKey(d,c),this.removeItem(b)},updateRecord:function(a,b){var c,d,e=a.constructor.primaryKeys[0];return e&&(d=a.get(e)||b[e]),c=this.getCacheKey(a.constructor.typeKey,d),this.putItem(c,b)},getCacheKey:function(a,b){return"%@: %@".fmt(a,b)},getItem:function(a){return new Ember.RSVP.Promise(function(b){var c=this.storage.getItem(a)||null;try{c=JSON.parse(c)}catch(d){c=c}b(c)}.bind(this))},putItem:function(a,b){return this.getItem(a).then(function(c){if(c){for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return this.setItem(a,c)}return this.setItem(a,b)}.bind(this))},setItem:function(a,b){return new Ember.RSVP.Promise(function(c){var d;d="string"==typeof b?b:JSON.stringify(b),this.storage.setItem(a,d),c(b)}.bind(this))},removeItem:function(a){return new Ember.RSVP.Promise(function(b){this.storage.removeItem(a),b()}.bind(this))}})},{"./cache-storage":3}],5:[function(a,b,c){"use strict";function d(a,b,c){var d=e.findMatching(a,b,c),f=c.indexOf(d);d?c[f]=a:c.push(a)}var e=a("./utils"),f=a("./cache-storage");c.get=function(a){var b=this.storage.getItem(a)||null;return JSON.parse(b)},c.storage=f.get(),c.set=function(a,b){var c=JSON.stringify(b);return this.storage.setItem(a,c)},c.getModels=function(a,b){var c=this.get(a),d=a.primaryKeys[0],e=this.get(b);return c?$.isArray(e)?c.filter(function(a){return e.contains(a[d])}):c.find(function(a){return a[d]===e}):null},c.update=function(a,b,c){var d,e=a.primaryKeys[0];this.updateClassStore(a,c),d=$.isArray(c)?c.map(function(a){return a[e]}):c[e],this.set(b,d)},c.updateClassStore=function(a,b){var c=this.get(a.toString())||[];return $.isArray(b)?b.forEach(function(b){d(b,a,c)}):d(b,a,c),this.set(a.toString(),c),c}},{"./cache-storage":3,"./utils":7}],6:[function(a,b,c){"use strict";b.exports=Ember.Mixin.create({filters:function(){return[]}.property(),replace:function(a,b,c){var d=this.get("filters");return d.forEach(function(a){c=c.filter(a)}),this._super(a,b,c)},runFilters:function(){return this.replace(0,this.length,this)}.observes("filters.[]")})},{}],7:[function(a,b,c){"use strict";c.arraysEqual=function(a,b){if(a.length!==b.length)return!1;for(var c,d,e;e<a.length;e++)if(c=a[e],d=b[e],!Ember.isEqual(c,d))return!1;return!0},c.objectsEqual=function(a,b){if(!a||!b)return!1;var c=Ember.keys(a),d=Ember.keys(b),e=this.arraysEqual(c,d);if(e){var f=c.every(function(c){return a[c]===b[c]});return f}return!1},c.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},c.findMatching=function(a,b,c){var d=b.primaryKeys[0];return c.find(function(b){return a[d]===b[d]})},c.findIn=function(a,b,c){return a.reduce(function(a,d){var e=this.findMatching(d,c,b);return e&&a.push(d),a}.bind(this),[])},c.findNotIn=function(a,b,c){return a.reduce(function(a,d){var e=this.findMatching(d,c,b);return e||a.push(d),a}.bind(this),[])}},{}]},{},[1])(1)});