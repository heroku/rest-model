!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.RestModel=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d=a("./lib/mutating-array"),e=a("./lib/cache").create(),f=a("./lib/utils");b.exports=Ember.Object.extend({isRestModelClass:!0,init:function(){this.setOriginalProperties(),this._definePrimaryKey(),this._defineDirtyProperties()},attrs:function(){return[]}.property(),inFlight:Ember.computed.bool("requestPool"),isClean:Ember.computed.empty("dirtyProperties"),isDirty:Ember.computed.notEmpty("dirtyProperties"),isNew:Ember.computed.none("primaryKey"),isPersisted:Ember.computed.not("isNew"),attrNames:function(){return this.get("attrs").map(function(a){return/\.\[\]$/.test(a)?a.split(".")[0]:a})}.property("attrs"),parents:function(){var a=this.constructor.getParentKeyNames();return a.reduce(function(a,b){return a[b]=this.get(b),a}.bind(this),{})}.property()["volatile"](),path:function(){var a=this.get("isPersisted")?this.get("primaryKey"):null,b=this.get("parents");return this.constructor.buildPath(b,a)}.property("isPersisted","primaryKey","parents"),"delete":function(a){return this.request("deleting",function(){return a=f.extend({url:this.get("path"),type:"DELETE"},a),this.constructor.ajax(a).then(function(){return e.removeRecord(this)}.bind(this))}.bind(this))},fetch:function(a){return this.request("fetching",function(){return a=f.extend({url:this.get("path"),type:"GET"},a),this.constructor.request(a,{},this).then(function(a){var b=this.constructor.getUpdatableProperties(a);return this.setProperties(b),this.setOriginalProperties(),this}.bind(this))}.bind(this))},persistToCache:function(a){return e.updateRecord(this,a)},request:function(a,b){return a="is"+a.capitalize(),this.set(a,!0),this.incrementProperty("requestPool"),b()["finally"](function(){this.set(a,!1),this.decrementProperty("requestPool")}.bind(this))},revert:function(){var a=this.get("attrs");this.get("attrNames").forEach(function(b,c){var d=Ember.copy(this.get("originalProperties."+b));/\.\[\]$/.test(a[c])?this.get(b).setObjects(d):this.set(b,d)}.bind(this))},save:function(a){var b=this.get("isNew")?"POST":"PATCH";return this.request("saving",function(){return a=f.extend({url:this.get("path"),type:b,data:this.serialize()},a),this.constructor.ajax(a).then(function(a){return this.persistToCache(a.data)}.bind(this)).then(function(a){return this.setProperties(a),this.setOriginalProperties(),this}.bind(this))}.bind(this))},setOriginalProperties:function(){var a=this.get("attrNames");this.set("originalProperties",a.reduce(function(a,b){var c=this.get(b);return a.set(b,Ember.copy(c,!0)),a}.bind(this),Ember.Object.create()))},getDirtyProperties:function(){var a=this.get("attrNames"),b=this.get("originalProperties");return a.reduce(function(a,c){var d=this.get(c),e=b.get(c);return Ember.isArray(d)?f.arraysEqual(d,e)||a.push(c):Ember.$.isPlainObject(d)?f.objectsEqual(d,e)||a.push(c):Ember.isEqual(d,e)||a.push(c),a}.bind(this),[])},serialize:function(){return JSON.stringify(this.toObject())},toObject:function(){return this.get("attrNames").reduce(function(a,b){var c=this.get(b);return a[b]=c,a}.bind(this),{})},_definePrimaryKey:function(){var a=this.constructor.primaryKeys,b=this.constructor.primaryKeys.concat({get:function(){for(var b,c,d=0;d<a.length;d++)if(b=a[d],c=this.get(b),!Ember.isNone(c))return c},set:function(b,c,d){return this.get("primaryKey")!==d&&this.set(a[0],d),d}}),c=Ember.computed.apply(Ember,b);Ember.defineProperty(this,"primaryKey",c)},_defineDirtyProperties:function(){var a=this.get("attrs").concat("originalProperties",this.getDirtyProperties),b=Ember.computed.apply(Ember,a);Ember.defineProperty(this,"dirtyProperties",b)}}).reopenClass({typeKey:"",primaryKeys:["id"],namespace:null,base:"",cache:!1,filters:[],ajax:function(a){var b={type:"GET",dataType:"json",contentType:"application/json"};return f.extend(b,a),new Ember.RSVP.Promise(function(a,c){Ember.$.ajax(b).then(function(b,c,d){d=d||{},b=Ember.isArray(b)?this.deserializeArray(b):this.deserialize(b),a({data:b,status:d.status})}.bind(this),function(a){delete a.then,c(a)})}.bind(this))},all:function(a,b){b=f.extend({url:this.buildPath(a),type:"GET"},b);var c={parents:a};return this.request(b,c).then(function(a){return a})},addParentsToPath:function(a,b){return Ember.$.each(a,function(a,c){var d=c;"string"!=typeof c&&"number"!=typeof c&&(d=c.get("primaryKey")),b=b.replace("/:"+a,"/"+d)}),b},assertHasParentKeys:function(a){this.getParentKeyNames().forEach(function(b){var c=a[b],d=c?this.getPrimaryKey(c):null;if(Ember.isNone(d))throw new Error('No primary key found for parent "'+b+'".')}.bind(this))},buildPath:function(a,b){var c="/"+this.base;return Ember.$.isPlainObject(a)||(b=a,a={}),this.assertHasParentKeys(a),c=this.addParentsToPath(a,c),Ember.isNone(b)||(c+="/"+b),Ember.isNone(this.namespace)||(c="/"+this.namespace+c),c},deserialize:function(a){return a},deserializeArray:function(a){return a.map(this.deserialize.bind(this))},find:function(a,b,c){return Ember.$.isPlainObject(a)||(c=b,b=a,a={}),c=f.extend({url:this.buildPath(a,b),type:"GET"},c),this.request(c).then(this.create.bind(this)).then(function(b){return b.setProperties(a),b})},getParentKeyNames:function(){var a=this.base.match(/\/:[^\/]+/g)||[];return a.map(function(a){return a.replace("/:","")})},getPrimaryKey:function(a){return"number"==typeof a||"string"==typeof a?a:a.get("primaryKey")},toResult:function(a,b){if(b=b||{},Ember.isArray(a)){var c=a.map(function(a){var c=this.create(a);return c.setProperties(b),c}.bind(this)),e=d.apply(c);return e.set("filters",Ember.copy(this.filters)),e.runFilters()}var f=this.create(a);return f.setProperties(b),f},request:function(a,b,c){var d=(this.cache||a.cache)&&"get"===a.type.toLowerCase();return b=f.extend({toResult:this.toResult.bind(this)},b),d?this.requestWithCache(a,b,c):this.ajax(a).then(function(a){var c=b.parents;return b.toResult(a.data,c)})},requestWithCache:function(a,b,c){var d;return e.getResponse(this,a.url).then(function(e){var f;return d=e,d?(f=b.toResult(d,b.parents),this.ajaxAndUpdateCache(a,b,c||f),f):this.ajaxAndUpdateCache(a,b).then(function(a){return b.toResult(a)})}.bind(this)).then(function(a){return a})},ajaxAndUpdateCache:function(a,b,c){var d=b.parents;return this.ajax(a).then(function(b){return 304===b.status?b.data:e.setResponse(this,a.url,b.data)}.bind(this)).then(function(a){var e=b.toResult(a,d);return c&&c!==a?Ember.isArray(e)?this.updateCachedArray(c,e):this.updateCachedObject(c,e):e}.bind(this))},updateCachedArray:function(a,b){var c=f.findNotIn(b,a,this),d=f.findNotIn(a,b,this),e=f.findIn(a,b,this);return a.pushObjects(c),a.removeObjects(d),e.forEach(function(a){if(!a.get("isDirty")){var c=f.findMatching(a,this,b);c=this.getUpdatableProperties(c),a.setProperties(c),a.setOriginalProperties()}}.bind(this)),a},updateCachedObject:function(a,b){return a.get("isDirty")?void 0:(b=this.getUpdatableProperties(b),a.setProperties(b),a.setOriginalProperties(),a)},getUpdatableProperties:function(a){var b=Object.keys(a).filter(function(a){return-1===["primaryKey","originalProperties","dirtyProperties"].indexOf(a)});return a.getProperties(b)},create:function(a){if(a=a||{},a.isRestModelClass){var b={},c={};return Object.keys(a).forEach(function(d){var e=a[d];e instanceof Ember.ComputedProperty?c[d]=e:b[d]=e}),this.extend(c)._super.call(this,b)}return this._super.call(this,a)}})},{"./lib/cache":3,"./lib/mutating-array":4,"./lib/utils":5}],2:[function(a,b,c){"use strict";function d(){var a=function(){};this.getItem=a,this.setItem=a,this.removeItem=a,this.clear=a,this.key=a,this.length=0}b.exports.NullStorage=d,b.exports.get=function(){try{return localStorage.setItem("_rest-model",!0),localStorage.removeItem("_rest-model",!0),localStorage}catch(a){return new d}}},{}],3:[function(a,b,c){"use strict";var d=a("./cache-storage");b.exports=Ember.Object.extend({getResponse:function(a,b){return this.getItem(b).then(function(b){return Ember.isArray(b)?this.getArrayResponse(a,b):this.getItemResponse(a,b)}.bind(this))},storage:d.get(),getArrayResponse:function(a,b){return Ember.RSVP.all(b.map(function(b){var c=this.getCacheKey(a.typeKey,b);return this.getItem(c)}.bind(this))).then(function(a){return a.compact()})},getItemResponse:function(a,b){var c=this.getCacheKey(a.typeKey,b);return this.getItem(c)},setResponse:function(a,b,c){return Ember.isArray(c)?this.setArrayResponse(a,b,c):this.setItemResponse(a,b,c)},setArrayResponse:function(a,b,c){var d=a.primaryKeys[0],e=c.mapBy(d);return Ember.RSVP.all([this.setItem(b,e),c.map(function(b){var c=this.getCacheKey(a.typeKey,b[d]);return this.putItem(c,b)}.bind(this))]).then(function(){return c})},setItemResponse:function(a,b,c){var d=a.primaryKeys[0],e=c[d],f=this.getCacheKey(a.typeKey,e);return Ember.RSVP.all([this.putItem(f,c),this.setItem(b,e)]).then(function(){return c})},removeRecord:function(a){var b,c,d=a.constructor.typeKey;return a.constructor.primaryKeys.length&&(c=a.get(a.constructor.primaryKeys[0])),b=this.getCacheKey(d,c),this.removeItem(b)},updateRecord:function(a,b){var c,d,e=a.constructor.primaryKeys[0];return e&&(d=a.get(e)||b[e]),c=this.getCacheKey(a.constructor.typeKey,d),this.putItem(c,b)},getCacheKey:function(a,b){return a+": "+b},getItem:function(a){return new Ember.RSVP.Promise(function(b){var c=this.storage.getItem(a)||null;try{c=JSON.parse(c)}catch(d){c=c}b(c)}.bind(this))},putItem:function(a,b){return this.getItem(a).then(function(c){if(c){for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return this.setItem(a,c)}return this.setItem(a,b)}.bind(this))},setItem:function(a,b){return new Ember.RSVP.Promise(function(c){var d;d="string"==typeof b?b:JSON.stringify(b),this.storage.setItem(a,d),c(b)}.bind(this))},removeItem:function(a){return new Ember.RSVP.Promise(function(b){this.storage.removeItem(a),b()}.bind(this))}})},{"./cache-storage":2}],4:[function(a,b,c){"use strict";b.exports=Ember.Mixin.create({filters:function(){return[]}.property(),replace:function(a,b,c){var d=this.get("filters");return d.forEach(function(a){c=c.filter(a)}),this._super(a,b,c)},runFilters:function(){return this.replace(0,this.length,this)}.observes("filters.[]")})},{}],5:[function(a,b,c){"use strict";c.arraysEqual=function(a,b){if(a.length!==b.length)return!1;for(var c,d,e=0;e<a.length;e++)if(c=a[e],d=b[e],!Ember.isEqual(c,d))return!1;return!0},c.objectsEqual=function(a,b){if(!a||!b)return!1;var c=Object.keys(a),d=Object.keys(b),e=this.arraysEqual(c,d);if(e){var f=c.every(function(c){return a[c]===b[c]});return f}return!1},c.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},c.findMatching=function(a,b,c){var d=b.primaryKeys[0];return c.find(function(b){return a[d]===b[d]})},c.findIn=function(a,b,c){return a.reduce(function(a,d){var e=this.findMatching(d,c,b);return e&&a.push(d),a}.bind(this),[])},c.findNotIn=function(a,b,c){return a.reduce(function(a,d){var e=this.findMatching(d,c,b);return e||a.push(d),a}.bind(this),[])}},{}]},{},[1])(1)});